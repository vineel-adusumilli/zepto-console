(function(g){g.fn.console=function(d){function A(){b=0;c="";k=0;u=!0;v=g('<div class="zepto-console-prompt-box"></div>');var a=g('<span class="zepto-console-prompt-label"></span>');v.append(a.text(j.continuedPrompt?Q:R).show());a.html(a.html().replace(" ","&nbsp;"));B=g('<span class="zepto-console-prompt"></span>');v.append(B);f.append(v);h()}function G(a){0!=s.length&&(k+=a,0>k?k=s.length:k>s.length&&(k=0),c=0==k?w:s[k-1],d.historyPreserveColumn?c.length<b+1?b=c.length:0==b&&(b=c.length):b=c.length,
h())}function H(){G(-1)}function I(){G(1)}function t(){return b<c.length?(w=c=c.substring(0,b)+c.substring(b+1),!0):!1}function J(){t()&&h()}function C(){f[0].scrollTop=f[0].scrollHeight-f.height()}function K(){if("function"==typeof d.commandHandle){u=!1;s.push(c);w="";var a=c;(n=j.continuedPrompt?n?n+("\n"+c):c:void 0)&&(a=n);a=d.commandHandle(a,function(a){l(a)});j.continuedPrompt&&!n&&(n=c);"boolean"==typeof a?a?l():l("Command failed.","zepto-console-message-error"):"string"==typeof a?l(a,"zepto-console-message-success"):
"object"==typeof a&&a.length?l(a):j.continuedPrompt&&l()}}function l(a,c){b=-1;h();if("string"==typeof a)D(a,c);else if(g.isArray(a))for(var S in a){var d=a[S];D(d.msg,d.className)}else f.append(a);A()}function D(a,c){var b=g('<div class="zepto-console-message"></div>');c&&b.addClass(c);b.filledText(a).hide();f.append(b);b.show()}function q(a){return 0<=b+a&&b+a<=c.length?(b+=a,!0):!1}function x(){return q(1)?(h(),!0):!1}function y(){return q(-1)?(h(),!0):!1}function L(){q(-b)&&h()}function M(){q(c.length-
b)&&h()}function r(a){return"string"==typeof a?(a=a.charCodeAt(),a>="A".charCodeAt()&&a<="Z".charCodeAt()||a>="a".charCodeAt()&&a<="z".charCodeAt()||a>="0".charCodeAt()&&a<="9".charCodeAt()):!1}function h(){var a=c,p="";if(0<b&&""==a)p=N;else if(b==c.length)p=z(a)+N;else{var p=a.substring(0,b),d=a.substring(b,b+1);d&&(d='<span class="zepto-console-cursor">'+z(d)+"</span>");a=a.substring(b+1);p=z(p)+d+z(a)}B.html(p);C()}function z(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/</g,
"&lt;").replace(/ /g,"&nbsp;").replace(/\n/g,"<br />")}var E={37:y,39:x,38:H,40:I,8:function(){q(-1)&&(t(),h())},46:J,35:M,36:L,13:function(){var a=c;"function"==typeof d.commandValidate?(a=d.commandValidate(a),!0==a||!1==a?a&&K():l(a,"zepto-console-message-error")):K()},18:function(){}},O={65:L,69:M,68:J,78:I,80:H,66:y,70:x,75:function(){for(;t();)h()}},P={70:function(){for(;b<c.length&&!r(c[b])&&x(););for(;b<c.length&&r(c[b])&&x(););},66:function(){for(;0<=b-1&&!r(c[b-1])&&y(););for(;0<=b-1&&r(c[b-
1])&&y(););},68:function(){for(;b<c.length&&!r(c[b]);)t(),h();for(;b<c.length&&r(c[b]);)t(),h()}},N='<span class="zepto-console-cursor">&nbsp;</span>',F=g(this),f=g('<div class="zepto-console-inner"></div>'),e=g('<textarea class="zepto-console-typer"></textarea>'),v,B,R=d&&d.promptLabel?d.promptLabel:"> ",Q=d&&d.continuedPromptLabel?d.continuedPromptLabel:"> ",b=0,c="",w="",n="",s=[],k=0,m=0,u=!0,j={};F.append(f);f.append(e);e.css({position:"absolute",top:0,left:"-9999px"});d.welcomeMessage&&D(d.welcomeMessage,
"zepto-console-welcome");A();d.autofocus&&(f.addClass("zepto-console-focus"),e.focus(),setTimeout(function(){f.addClass("zepto-console-focus");e.focus()},100));j.inner=f;j.typer=e;j.scrollToBottom=C;j.reset=function(){var a="undefined"!=typeof d.welcomeMessage;f.parent().fadeOut(function(){f.find("div").each(function(){a?a=!1:g(this).remove()});A();f.parent().fadeIn(function(){f.addClass("zepto-console-focus");e.focus()})})};j.notice=function(a,c){var b=g('<div class="notice"></div>').append(g("<div></div>").text(a)).css({visibility:"hidden"});
F.append(b);var d=!0;if("fadeout"==c)setTimeout(function(){b.fadeOut(function(){b.remove()})},4E3);else if("prompt"==c){var e=g('<br/><div class="action"><a href="javascript:">OK</a><div class="clear"></div></div>');b.append(e);d=!1;e.click(function(){b.fadeOut(function(){b.remove();f.css({opacity:1})})})}e=b.height();b.css({height:"0px",visibility:"visible"}).animate({height:e+"px"},function(){d||f.css({opacity:0.5})});b.css("cursor","default");return b};F.click(function(){f.addClass("zepto-console-focus");
f.removeClass("zepto-console-nofocus");e.focus();C();return!1});e.blur(function(){f.removeClass("zepto-console-focus");f.addClass("zepto-console-nofocus")});e.bind("paste",function(){e.val("");setTimeout(function(){e.consoleInsert(e.val());e.val("")},0)});e.keydown(function(a){m=0;var b=a.keyCode;if(a.ctrlKey&&67==b)return m=b,"function"==typeof d.cancelHandle&&d.cancelHandle(),!1;if(u){if(b in E)return m=b,E[b](),!1;if(a.ctrlKey&&b in O)return m=b,O[b](),!1;if(a.altKey&&b in P)return m=b,P[b](),
!1}});e.keypress(function(a){var b=a.keyCode||a.which;if((a.keyCode==E.tab||192==a.keyCode)&&a.altKey)return!1;if((a.ctrlKey||a.metaKey)&&"v"==String.fromCharCode(b).toLowerCase())return!0;if(u&&m!=b&&32<=b){if(m)return!1;("undefined"==typeof d.charInsertTrigger||"function"==typeof d.charInsertTrigger&&d.charInsertTrigger(b,c))&&e.consoleInsert(b)}if(g.browser.webkit)return!1});e.consoleInsert=function(a){a=isNaN(a)?a:String.fromCharCode(a);var d=c.substring(0,b),e=c.substring(b);c=d+a+e;q(a.length);
w=c;h()};j.promptText=function(a){a&&(c=a,b=c.length,h());return c};return j};g.fn.filledText=function(d){g(this).text(d);g(this).html(g(this).html().replace(/\n/g,"<br/>"));return this}})(Zepto);
